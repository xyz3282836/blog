import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as h,o as t}from"./app-B5c4UNHh.js";const n={};function l(k,i){return t(),a("div",null,[...i[0]||(i[0]=[h(`<h2 id="基础" tabindex="-1"><a class="header-anchor" href="#基础"><span>基础</span></a></h2><h3 id="生成位掩码" tabindex="-1"><a class="header-anchor" href="#生成位掩码"><span>生成位掩码</span></a></h3><p>将一个 <code>uint16</code> 转换为形如 <code>2^n-1</code> 的数（二进制表示为全是 1 的位掩码）</p><div class="language-go" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> maskOfNextPowOf2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">cap</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint16</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uint32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> cap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	cap</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> |=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	cap</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> |=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	cap</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> |=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 4</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> |</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cap</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 8</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>先判断大于0，且 cap 是否为 2 的幂</p><ul><li>如果是，则返回 cap-1，否则返回一个掩码（mask），用于后续位运算。</li><li>如果 不是 ，通过一系列位运算，把 cap 的二进制从最高位的 1 开始，后面的所有位都变成 1。 <ul><li>16位如<code>1xxx,xxx,xxxx,xxxx</code>，<code>cap |= (cap &gt;&gt; 1)</code>j过一次移位得到<code>01xx,xxxx,xxxx,xxxx</code>，在<code>|</code>或操作得到<code>11xx,xxxx,xxxx,xxxx</code></li><li><code>cap |= (cap &gt;&gt; 2)</code>得到<code>1111,xxxx,xxxx,xxxx</code></li><li><code>cap |= (cap &gt;&gt; 4)</code>得到<code>1111,1111,xxxx,xxxx</code></li><li><code>cap |= (cap &gt;&gt; 8)得到</code>得到<code>1111,1111,1111,1111</code></li></ul></li></ul><h3 id="优化哈希取模操作" tabindex="-1"><a class="header-anchor" href="#优化哈希取模操作"><span>优化哈希取模操作</span></a></h3><ul><li>传统取模：<code>hash % size</code>（性能较低）</li><li>优化方式：<code>hash &amp; mask</code>（性能更好）</li><li>前提是 size 必须是 2 的幂，而 mask = size - 1</li></ul><h3 id="hashbkdr" tabindex="-1"><a class="header-anchor" href="#hashbkdr"><span>hashBKDR</span></a></h3><p><code>hashBKDR</code> 函数是一种字符串哈希算法实现，通常用于将字符串转换为整数哈希值。这个算法的名称来源于它的作者 Brian Kernighan 和 Dennis Ritchie（即 K&amp;R，《C程序设计语言》的作者）。</p><p>在缓存系统中，这种哈希函数通常用于：</p><ol><li>计算键（key）的哈希值，用于确定数据应该存储在哪个分片或桶中</li><li>降低字符串比较的开销，通过先比较哈希值再比较原始字符串</li><li>实现高效的字符串到整数的映射</li></ol><p>BKDR哈希算法的典型实现如下：</p><div class="language-go" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> hashBKDR</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">s</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uint32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    var</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> seed</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint32</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 131</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // 31, 131, 1313, 13131... 都是不错的选择</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    var</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hash</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint32</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        hash</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hash</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">seed</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">])</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> hash</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre></div><p>这个算法的特点是：</p><ul><li>实现简单</li><li>计算速度快</li><li>冲突率较低</li><li>分布均匀性好</li></ul><p>在分片缓存或需要快速定位数据的场景中，这种哈希函数非常有用，因为它可以将任意长度的字符串映射到固定范围的整数值，便于后续的索引操作。</p>`,17)])])}const r=s(n,[["render",l]]),d=JSON.parse('{"path":"/tech/source/ecache/ecache.html","title":"ecache","lang":"zh-CN","frontmatter":{"title":"ecache","date":"2025-07-04T02:45:00.000Z","category":"技术","tag":["ecache","LRU"],"description":"基础 生成位掩码 将一个 uint16 转换为形如 2^n-1 的数（二进制表示为全是 1 的位掩码） 先判断大于0，且 cap 是否为 2 的幂 如果是，则返回 cap-1，否则返回一个掩码（mask），用于后续位运算。 如果 不是 ，通过一系列位运算，把 cap 的二进制从最高位的 1 开始，后面的所有位都变成 1。 16位如1xxx,xxx,xx...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ecache\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-07-04T02:45:00.000Z\\",\\"dateModified\\":\\"2025-10-16T09:34:20.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"ruizhou\\",\\"url\\":\\"https://blog.ruizhou.cf\\"}]}"],["meta",{"property":"og:url","content":"https://blog.ruizhou.cf/tech/source/ecache/ecache.html"}],["meta",{"property":"og:site_name","content":"rz blog"}],["meta",{"property":"og:title","content":"ecache"}],["meta",{"property":"og:description","content":"基础 生成位掩码 将一个 uint16 转换为形如 2^n-1 的数（二进制表示为全是 1 的位掩码） 先判断大于0，且 cap 是否为 2 的幂 如果是，则返回 cap-1，否则返回一个掩码（mask），用于后续位运算。 如果 不是 ，通过一系列位运算，把 cap 的二进制从最高位的 1 开始，后面的所有位都变成 1。 16位如1xxx,xxx,xx..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-10-16T09:34:20.000Z"}],["meta",{"property":"article:tag","content":"LRU"}],["meta",{"property":"article:tag","content":"ecache"}],["meta",{"property":"article:published_time","content":"2025-07-04T02:45:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-10-16T09:34:20.000Z"}]]},"git":{"createdTime":1760607260000,"updatedTime":1760607260000,"contributors":[{"name":"liuruizhou","username":"liuruizhou","email":"liuruizhou@bilibili.com","commits":1,"url":"https://github.com/liuruizhou"}]},"readingTime":{"minutes":1.83,"words":550},"filePathRelative":"tech/source/ecache/ecache.md","excerpt":"","autoDesc":true}');export{r as comp,d as data};
