import{_ as s}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,a as t,o as n}from"./app-BNtsTiGX.js";const l={};function e(h,i){return n(),a("div",null,[...i[0]||(i[0]=[t(`<h3 id="èƒŒæ™¯" tabindex="-1"><a class="header-anchor" href="#èƒŒæ™¯"><span>èƒŒæ™¯</span></a></h3><p>gcçš„å‡ ä¸ªé‡è¦é˜¶æ®µ</p><ol><li><p>sweep termination æ¸…ç†ç»ˆæ­¢ï¼šæ¸…ç†ç»ˆæ­¢ï¼Œä¼šè§¦å‘stwï¼Œæ‰€æœ‰Péƒ½ä¼šè¿›å…¥sage-point å®‰å…¨ç‚¹ï¼Œå‡†å¤‡æ–°ä¸€è½®çš„gcï¼›</p><p><strong>è§¦å‘ STWï¼ˆStop-the-Worldï¼‰</strong>ï¼Œè®©æ‰€æœ‰çš„ <strong>Pï¼ˆProcessorï¼‰</strong> åœæ­¢ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œå¹¶è¿›å…¥ <strong>safe-pointï¼ˆå®‰å…¨ç‚¹ï¼‰</strong>ã€‚</p><p>ğŸ”§ <strong>å…³é”®ç‚¹ï¼š</strong></p><ul><li><p><strong>safe-point</strong> æ˜¯ GC å¯ä»¥å®‰å…¨æ‰§è¡Œçš„åœ°æ–¹ï¼Œé˜²æ­¢ç”¨æˆ·ä»£ç ä¿®æ”¹å†…å­˜ç»“æ„ã€‚</p></li><li><p>åœ¨è¿™ä¸ªé˜¶æ®µï¼ŒGo runtime ä¼šï¼š</p><ul><li><strong>åœæ­¢ç”¨æˆ·ä»£ç </strong>ï¼›</li><li>ç¡®ä¿ä¹‹å‰çš„æ¸…ç†é˜¶æ®µå®Œæˆï¼›</li><li>å‡†å¤‡å¼€å§‹<strong>æ–°çš„æ ‡è®°é˜¶æ®µ</strong>ã€‚</li></ul></li></ul></li><li><p>the mark phase æ ‡è®°é˜¶æ®µï¼šç¨‹åºå’ŒgcåŒæ—¶è¿è¡Œï¼Œgcæ‰§è¡Œæ ¹èŠ‚ç‚¹çš„æ ‡è®°ï¼Œè¿™åŒ…æ‹¬æ‰«ææ‰€æœ‰çš„æ ˆï¼Œå…¨å±€å¯¹è±¡ä»¥åŠä¸åœ¨å †ä¸­è¿è¡Œæ—¶æ•°æ®ç»“æ„ï¼›</p><p><strong>å¹¶å‘æ‰§è¡Œ</strong>ï¼ŒGC å’Œç”¨æˆ·ä»£ç åŒæ—¶è¿è¡Œã€‚</p><p>ğŸ”§ <strong>å…³é”®ç‚¹ï¼š</strong></p><ul><li><p>ä»æ ¹å¯¹è±¡ï¼ˆroot setï¼‰å¼€å§‹ï¼Œæ ‡è®°æ‰€æœ‰<strong>å¯è¾¾å¯¹è±¡</strong>ã€‚</p></li><li><p>æ ¹å¯¹è±¡åŒ…æ‹¬ï¼š</p><ul><li><strong>æ ˆå˜é‡</strong>ï¼›</li><li><strong>å…¨å±€å˜é‡</strong>ï¼›</li><li><strong>è¿è¡Œæ—¶æ•°æ®ç»“æ„</strong>ã€‚</li></ul></li><li><p>ä½¿ç”¨ <strong>å†™å±éšœï¼ˆWrite Barrierï¼‰</strong> ç¡®ä¿åœ¨æ ‡è®°é˜¶æ®µäº§ç”Ÿçš„æ–°å¯¹è±¡ä¹Ÿèƒ½è¢«æ­£ç¡®æ ‡è®°ã€‚</p></li></ul><p>ğŸ’¡ <strong>å†™å±éšœçš„ä½œç”¨</strong>ï¼š</p><ul><li>é˜²æ­¢åœ¨æ ‡è®°é˜¶æ®µï¼Œç”¨æˆ·ä»£ç åˆ†é…æ–°å¯¹è±¡æ—¶ï¼Œè¿™äº›å¯¹è±¡è¢«é—æ¼ã€‚</li><li>ç¡®ä¿å¹¶å‘æ ‡è®°çš„å‡†ç¡®æ€§ã€‚</li></ul></li><li><p>mark termination æ ‡è®°ç»ˆæ­¢ï¼šæ ‡è®°ç»ˆæ­¢ï¼Œè§¦å‘stwï¼Œç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½å·²æ ‡è®°å®Œæˆï¼ŒgcçŠ¶æ€å˜æ›´ï¼Œå…³é—­gcå·¥ä½œçº¿ç¨‹ï¼›</p><p><strong>è§¦å‘ STW</strong>ï¼Œæš‚åœæ‰€æœ‰ç”¨æˆ·ä»£ç ï¼Œç¡®ä¿æ ‡è®°è¿‡ç¨‹å®Œæˆã€‚</p><p>ğŸ”§ <strong>å…³é”®ç‚¹ï¼š</strong></p><ul><li><p>è¿›å…¥ STW çŠ¶æ€ï¼Œåœæ­¢ç”¨æˆ·ä»£ç ã€‚</p></li><li><p>æ‰§è¡Œä»¥ä¸‹ä»»åŠ¡ï¼š</p><ul><li>ç¡®ä¿æ‰€æœ‰å¯¹è±¡éƒ½å·²è¢«æ­£ç¡®æ ‡è®°ã€‚</li><li><strong>å…³é—­æ ‡è®°çº¿ç¨‹</strong>ã€‚</li><li>å‡†å¤‡è¿›å…¥æ¸…ç†é˜¶æ®µã€‚</li></ul></li></ul></li><li><p>sweep phase æ¸…ç†é˜¶æ®µï¼šæ¢å¤ç¨‹åºæ‰§è¡Œï¼Œåå°å¹¶å‘æ¸…ç†æ‰€æœ‰å†…å­˜ç®¡ç†å•å…ƒï¼›</p><p><strong>å¹¶å‘æ‰§è¡Œ</strong>ï¼Œå›æ”¶æœªæ ‡è®°çš„å†…å­˜å—ã€‚</p><p>ğŸ”§ <strong>å…³é”®ç‚¹ï¼š</strong></p><ul><li><p>æ¢å¤ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œæ¸…ç†é˜¶æ®µ<strong>åœ¨åå°å¹¶å‘è¿›è¡Œ</strong>ã€‚</p></li><li><p>å›æ”¶æ‰€æœ‰<strong>æœªæ ‡è®°çš„å¯¹è±¡</strong>ï¼Œå°†å®ƒä»¬çš„å†…å­˜å—æ”¾å…¥<strong>ç©ºé—²åˆ—è¡¨</strong>ï¼Œä¾›åç»­åˆ†é…ä½¿ç”¨ã€‚</p></li><li><p>æ¸…ç†é˜¶æ®µæ˜¯<strong>å¢é‡å®Œæˆ</strong>çš„ï¼Œé¿å…ä¸€æ¬¡æ€§æ¸…ç†é€ æˆé•¿æ—¶é—´æš‚åœã€‚</p></li></ul></li></ol><h3 id="è§¦å‘gc" tabindex="-1"><a class="header-anchor" href="#è§¦å‘gc"><span>è§¦å‘gc</span></a></h3><p>åœ¨ Go ä¸­ä¸»è¦ä¼šåœ¨ä¸‰ä¸ªåœ°æ–¹è§¦å‘ GCï¼š</p><p>1ã€ç›‘æ§çº¿ç¨‹ runtime.sysmon å®šæ—¶è°ƒç”¨ï¼›</p><p>2ã€æ‰‹åŠ¨è°ƒç”¨ runtime.GC å‡½æ•°è¿›è¡Œåƒåœ¾æ”¶é›†ï¼›</p><p>3ã€ç”³è¯·å†…å­˜æ—¶ runtime.mallocgc ä¼šæ ¹æ®å †å¤§å°åˆ¤æ–­æ˜¯å¦è°ƒç”¨ï¼›</p><h4 id="runtime-sysmon" tabindex="-1"><a class="header-anchor" href="#runtime-sysmon"><span>runtime.sysmon</span></a></h4><p>Go ç¨‹åºåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šåå°è¿è¡Œä¸€ä¸ªçº¿ç¨‹å®šæ—¶æ‰§è¡Œ runtime.sysmon å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨æ¥æ£€æŸ¥æ­»é”ã€è¿è¡Œè®¡æ—¶å™¨ã€è°ƒåº¦æŠ¢å ã€ä»¥åŠ GC ç­‰ã€‚</p><p>å®ƒä¼šæ‰§è¡Œ <code>runtime.gcTrigger</code>ä¸­çš„ test å‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦åº”è¯¥è¿›è¡Œ GCã€‚ç”±äº GC å¯èƒ½éœ€è¦æ‰§è¡Œæ—¶é—´æ¯”è¾ƒé•¿ï¼Œæ‰€ä»¥è¿è¡Œæ—¶ä¼šåœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶åœ¨åå°å¼€å¯ä¸€ä¸ªç”¨äºå¼ºåˆ¶è§¦å‘åƒåœ¾æ”¶é›†çš„ Goroutine æ‰§è¡Œ forcegchelper å‡½æ•°ã€‚</p><p>ä¸è¿‡ forcegchelper å‡½æ•°åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ä¼šä¸€ç›´è¢« goparkunlock å‡½æ•°ä¸€ç›´æŒ‚èµ·ï¼Œç›´åˆ° sysmon è§¦å‘GC æ ¡éªŒé€šè¿‡ï¼Œæ‰ä¼šå°†è¯¥è¢«æŒ‚èµ·çš„ Goroutine æ”¾è½¬èº«åˆ°å…¨å±€è°ƒåº¦é˜Ÿåˆ—ä¸­ç­‰å¾…è¢«è°ƒåº¦æ‰§è¡Œ GCã€‚</p><h4 id="runtime-gc" tabindex="-1"><a class="header-anchor" href="#runtime-gc"><span>runtime.GC</span></a></h4><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œä¼šè·å–å½“å‰çš„ GC å¾ªç¯æ¬¡æ•°ï¼Œç„¶åè®¾å€¼ä¸º gcTriggerCycle æ¨¡å¼è°ƒç”¨ gcStart è¿›è¡Œå¾ªç¯ã€‚</p><h4 id="runtime-mallocgc" tabindex="-1"><a class="header-anchor" href="#runtime-mallocgc"><span>runtime.mallocgc</span></a></h4><p>tiny mallocã€small alloc éƒ½ä¼šå…ˆå» mcache ä¸­æ‰¾ç©ºé—²å†…å­˜å—è¿›è¡Œå†…å­˜åˆ†é…ï¼Œå¦‚æœ mcache ä¸­åˆ†é…ä¸åˆ°å†…å­˜ï¼Œå°±è¦åˆ° mcentral æˆ– mheap ä¸­å»ç”³è¯·å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå°è¯•è§¦å‘ GCï¼›è€Œå¯¹äº large alloc ä¸€å®šä¼šå°è¯•è§¦å‘ GC å› ä¸ºå®ƒç›´æ¥åœ¨å †é¡µä¸Šåˆ†é…å†…å­˜ã€‚</p><h3 id="æ§åˆ¶gc" tabindex="-1"><a class="header-anchor" href="#æ§åˆ¶gc"><span>æ§åˆ¶gc</span></a></h3><p>ä¸Šé¢è¿™ä¸‰ä¸ªè§¦å‘ GC çš„åœ°æ–¹æœ€ç»ˆéƒ½ä¼šè°ƒç”¨ gcStart æ‰§è¡Œ GCï¼Œä½†æ˜¯åœ¨æ‰§è¡Œ GC ä¹‹å‰ä¸€å®šä¼šå…ˆåˆ¤æ–­è¿™æ¬¡è°ƒç”¨æ˜¯å¦åº”è¯¥è¢«æ‰§è¡Œï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡è°ƒç”¨éƒ½ä¸€å®šä¼šæ‰§è¡Œ GCï¼Œ è¿™ä¸ªæ—¶å€™å°±è¦è¯´ä¸€ä¸‹ <code>runtime.gcTrigger</code>ä¸­çš„ test å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°è´Ÿè´£æ ¡éªŒæœ¬æ¬¡ GC æ˜¯å¦åº”è¯¥è¢«æ‰§è¡Œã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">t </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcTrigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">test</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">memstats</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">enablegc</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> panicking</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcphase</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> _GCoff</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	switch</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">kind</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	case</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcTriggerHeap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		trigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">_</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">trigger</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">heapLive</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> trigger</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	case</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcTriggerTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcController</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcPercent</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&lt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		lastgc</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">atomic</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">memstats</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">last_gc_nanotime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastgc</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">now</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastgc</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> forcegcperiod</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	case</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> gcTriggerCycle</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		// t.n &gt; work.cycles, but accounting for wraparound.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		return</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">n</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">work</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">cycles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>gcTriggerHeapï¼šæŒ‰å †å¤§å°è§¦å‘ï¼Œå †å¤§å°å’Œä¸Šæ¬¡ GC æ—¶ç›¸æ¯”è¾¾åˆ°ä¸€å®šé˜ˆå€¼åˆ™è§¦å‘ï¼›</li><li>gcTriggerTimeï¼šæŒ‰æ—¶é—´è§¦å‘ï¼Œå¦‚æœè¶…è¿‡ forcegcperiodï¼ˆé»˜è®¤2åˆ†é’Ÿï¼‰ æ—¶é—´æ²¡æœ‰è¢« GCï¼Œé‚£ä¹ˆä¼šæ‰§è¡ŒGCï¼›</li><li>gcTriggerCycleï¼šæ²¡æœ‰å¼€å¯åƒåœ¾æ”¶é›†ï¼Œåˆ™è§¦å‘æ–°çš„å¾ªç¯ï¼›</li></ul><h4 id="go-memory-ballast" tabindex="-1"><a class="header-anchor" href="#go-memory-ballast"><span>Go Memory Ballast</span></a></h4><p>é€šè¿‡è®¾ç½® ballast æ•°ç»„æˆ‘ä»¬è¾¾åˆ°äº†å»¶è¿Ÿ GC çš„æ•ˆæœï¼Œä½†æ˜¯è¿™ç§æ•ˆæœåªä¼šåœ¨ä¸´æ—¶å˜é‡æ¯”è¾ƒå¤šçš„ç³»ç»Ÿä¸­æœ‰ç”¨ï¼Œå¯¹äºå…¨å±€å˜é‡å¤šçš„ç³»ç»Ÿï¼Œç”¨å¤„ä¸å¤§ã€‚</p><h4 id="go-gc-tuner" tabindex="-1"><a class="header-anchor" href="#go-gc-tuner"><span>Go GC Tuner</span></a></h4><p>åœ¨ Go ä¸­å…¶å®æä¾›äº† <code>runtime.SetFinalizer</code> å‡½æ•°ï¼Œå®ƒä¼šåœ¨å¯¹è±¡è¢« GC çš„æ—¶å€™æœ€åå›è°ƒä¸€ä¸‹ã€‚å¯ä»¥é€šè¿‡å®ƒæ¥è®¾ç½®ä¸€ä¸ªé’©å­ï¼Œæ¯æ¬¡ GC å®Œä¹‹åæ£€æŸ¥ä¸€ä¸‹å†…å­˜æƒ…å†µï¼Œç„¶åè®¾ç½® GOGC å€¼ã€‚</p><h4 id="soft-memory-limit" tabindex="-1"><a class="header-anchor" href="#soft-memory-limit"><span>Soft Memory Limit</span></a></h4><p>Go å®ç°äº†ä¸‰ç§ç­–ç•¥è§¦å‘ GC ï¼Œå…¶ä¸­ä¸€ç§æ˜¯ gcTriggerHeapï¼Œå®ƒä¼šæ ¹æ®å †çš„å¤§å°è®¾å®šä¸‹æ¬¡æ‰§è¡Œ GC çš„å †ç›®æ ‡å€¼ã€‚ 1.19 ç‰ˆçš„ä»£ç æ­£æ˜¯å¯¹ gcTriggerHeap ç­–ç•¥åšäº†ä¿®æ”¹ã€‚</p><p><code>gcControllerState.heapGoalInternal</code>è®¡ç®— HeapGoal çš„æ—¶å€™ä½¿ç”¨äº†ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ GOGC å€¼è®¡ç®—ï¼Œå¦ä¸€ç§æ˜¯é€šè¿‡ memoryLimit å€¼è®¡ç®—ï¼Œç„¶åå–å®ƒä»¬ä¸¤ä¸ªä¸­å°çš„å€¼ä½œä¸º HeapGoalã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">c </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">gcControllerState</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">heapGoalInternal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">goal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">minTrigger</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> uint64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// Start with the goal calculated for gcPercent.</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	goal</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">gcPercentHeapGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// Check if the memory-limit-based goal is smaller, and if so, pick that.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> newGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">memoryLimitHeapGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">newGoal</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> goal</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		goal</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> newGoal</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		// We&#39;re not limited by the memory limit goal, so perform a series of</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		// adjustments that might move the goal forward in a variety of circumstances.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Go GC çš„è§¦å‘æ˜¯å–ä¸Šé¢ä¸¤è€…è®¡ç®—ç»“æœè¾ƒå°çš„å€¼ï¼Œé‚£ä¹ˆåŸæœ¬æˆ‘ä»¬ä½¿ç”¨ GOGC å¡«çš„å¤ªå¤§æ€•å¯¼è‡´ OOMï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥åŠ ä¸Š memoryLimit å‚æ•°é™åˆ¶ä¸€ä¸‹ï¼›æˆ–è€…ç›´æ¥ GOGC = off ï¼Œç„¶åè®¾ç½® memoryLimit å‚æ•°ï¼Œé€šè¿‡å®ƒæ¥è°ƒé…æˆ‘ä»¬çš„ GCã€‚</p>`,29)])])}const r=s(l,[["render",e]]),g=JSON.parse('{"path":"/tech/go/gc.html","title":"gc","lang":"zh-CN","frontmatter":{"title":"gc","date":"2025-01-13T08:14:00.000Z","category":"go","tag":["go","gc"],"description":"èƒŒæ™¯ gcçš„å‡ ä¸ªé‡è¦é˜¶æ®µ sweep termination æ¸…ç†ç»ˆæ­¢ï¼šæ¸…ç†ç»ˆæ­¢ï¼Œä¼šè§¦å‘stwï¼Œæ‰€æœ‰Péƒ½ä¼šè¿›å…¥sage-point å®‰å…¨ç‚¹ï¼Œå‡†å¤‡æ–°ä¸€è½®çš„gcï¼› è§¦å‘ STWï¼ˆStop-the-Worldï¼‰ï¼Œè®©æ‰€æœ‰çš„ Pï¼ˆProcessorï¼‰ åœæ­¢ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œå¹¶è¿›å…¥ safe-pointï¼ˆå®‰å…¨ç‚¹ï¼‰ã€‚ ğŸ”§ å…³é”®ç‚¹ï¼š safe-point æ˜¯ GC å¯...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"gc\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-01-13T08:14:00.000Z\\",\\"dateModified\\":\\"2025-10-16T09:34:20.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"ruizhou\\",\\"url\\":\\"https://blog.ruizhou.cf\\"}]}"],["meta",{"property":"og:url","content":"https://blog.ruizhou.cf/tech/go/gc.html"}],["meta",{"property":"og:site_name","content":"rz blog"}],["meta",{"property":"og:title","content":"gc"}],["meta",{"property":"og:description","content":"èƒŒæ™¯ gcçš„å‡ ä¸ªé‡è¦é˜¶æ®µ sweep termination æ¸…ç†ç»ˆæ­¢ï¼šæ¸…ç†ç»ˆæ­¢ï¼Œä¼šè§¦å‘stwï¼Œæ‰€æœ‰Péƒ½ä¼šè¿›å…¥sage-point å®‰å…¨ç‚¹ï¼Œå‡†å¤‡æ–°ä¸€è½®çš„gcï¼› è§¦å‘ STWï¼ˆStop-the-Worldï¼‰ï¼Œè®©æ‰€æœ‰çš„ Pï¼ˆProcessorï¼‰ åœæ­¢ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œå¹¶è¿›å…¥ safe-pointï¼ˆå®‰å…¨ç‚¹ï¼‰ã€‚ ğŸ”§ å…³é”®ç‚¹ï¼š safe-point æ˜¯ GC å¯..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-10-16T09:34:20.000Z"}],["meta",{"property":"article:tag","content":"gc"}],["meta",{"property":"article:tag","content":"go"}],["meta",{"property":"article:published_time","content":"2025-01-13T08:14:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-10-16T09:34:20.000Z"}]]},"git":{"createdTime":1736759483000,"updatedTime":1760607260000,"contributors":[{"name":"liuruizhou","username":"liuruizhou","email":"liuruizhou@bilibili.com","commits":2,"url":"https://github.com/liuruizhou"}]},"readingTime":{"minutes":4.96,"words":1487},"filePathRelative":"tech/go/gc.md","excerpt":"","autoDesc":true}');export{r as comp,g as data};
